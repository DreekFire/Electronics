# Maxwell Pointer
Using a smartphone magnetometer to track a magnetic stylus in 3D space

## Purpose
The goal of this project is to create a compact, pen-like object which can be located in space with the use of the sensors available to a common smartphone. This could be used to expand the touchscreen onto any flat surface, providing an alternative to SMARTboards or whiteboards when used in conjunction with a projector and also providing a more comfortable workflow for artists and designers. It could also be used as a 3D pen for use in sculpting or virtual and augmented reality. In addition, the phone could send the information wirelessly to a computer to be used in applications that are unavailable on mobile devices.
<!-- uwu -->
## Design
The pen will be made from three orthogonal coils wrapped around an iron core. These coils will be driven by three AC signals of different frequencies. We will use the fourier transform to extract the amplitude at each frequency along each axis of the magnetometer in each slice in time. This will provide nine readings: three axes multiplied by three waves. As we only have six variables, three for translation and three for rotation, only two non-parallel coils are theoretically needed, but we choose to include a third, as well as make all the coils orthogonal to each other, in order to maximize accuracy.
As we are interested in the pose of the tip of the pen, the coil should be placed as close to it as possible since error in rotation will be multiplied by the distance from the coil to the tip. The most comfortable position available while still resembling a pen is right behind the fingers, such as in a pencil grip.
The remaining electrical components will be placed in the barrel of the pen. Placing the components within the pen both increases portability and reduces the interference generated by current flowing through wires outside of the coils.

## Technical Details
### Design
Each orthogonal electromagnet will be represented as a magnetic dipole moment. This approximation increases in accuracy as the distance between the sensor and the coil increases. Absolute accuracy is not as important in our application, as the pen is being manipulated by a human who can use their senses to adjust. Increased accuracy could be useful to allow the pen to be used to trace 3D objects, however.
Each of three coils is powered by AC at a different frequency. We use the Fourier transform to extract the energy of the signal at each of those three frequencies. Then, we use an iterative least-squares process to find a relative pose for the pen which would produce that signal.

### Math
#### Setup
Defining a coordinate system centered on the generating coils and with axes pointing along the coil normals, we find that the magnetic field at position <x, y, z> is
B_x = B_T<3x^2/r^5 - 1/R^3, 3xy/R^5, 3xz/R^5> from the coil parallel to <1, 0, 0>
B_y = B_T<3xy/R^5, 3y^2/r^5 - 1/R^3, 3yz/R^5> from the coil parallel to <0, 1, 0>
B_z = B_T<3xz/R^5, 3yz/R^5, 3z^2/r^5 - 1/R^3> from the coil parallel to <0, 0, 1>
Where B_T is nIA(mu - mu_0)/4pi, where I is the current flowing through the coil, A is the area of the coil, n is the number of turns in the coil, mu is the permiability of the core material, and mu_0 is the permeability of free space.
#### Finding Position
While these formulas provide the magnetic field at point (x, y, z) relative to the standard basis, the measured values are relative to the basis defined by the sensor. Since the sensing coils are orthogonal to each other, if we define the sensor basis as consisting of unit vectors parallel to each sensor axis, then the change-of-basis matrix is orthonormal, and thus vector magnitude is preserved. Therefore, although the magnetometer cannot directly measure B_x, it can measure the magnitude of B_x.
Following the computations done in Hu et. al, from the equations
|B_x|^2 = |B_T|^2(3x^2/R^8 + 1/R^6)
|B_y|^2 = |B_T|^2(3y^2/R^8 + 1/R^6)
|B_z|^2 = |B_T|^2(3z^2/R^8 + 1/R^6)
We can compute that
x = +-sqrt(|B_x|^2/B_T^2 - B^2/6B_T^2)/(sqrt(3)(B^2/6B_T^2)^2/3)
y = +-sqrt(|B_y|^2/B_T^2 - B^2/6B_T^2)/(sqrt(3)(B^2/6B_T^2)^2/3)
z = +-sqrt(|B_z|^2/B_T^2 - B^2/6B_T^2)/(sqrt(3)(B^2/6B_T^2)^2/3)
Continuing to follow Hu et. al, we know that since angles are preserved, the dot products between pairs of vectors relative to either basis must be the same. We can then determine the signs of x, y, and z based on the signs of B_x\*B_y, B_x\*B_z, and B_y*B_z.

#### Finding Orientation
Finally, we can determine the change-of-basis matrix to convert from the standard basis to the sensor basis. As previously mentioned, it is orthonormal, so it is a rotation matrix which we will call R.
R right multiplied by the standard basis field vectors results in the sensor basis vectors, which is what our magnetometer measures. Therefore, R is the matrix with the measured vectors as rows right multiplied by the inverse of the matrix with the standard basis vectors as rows.
Thus, the position of the generating coils relative to the sensor basis is -R<x, y, z> and their orientation is Re_1, Re_2, and Re_3.

#### Least-Squares Regression
Our computations resulted in an R^3 vector for position along with an R^3 vector for orientation. In total, there are six unknowns, but nine equations—each of the sensor axes measures a value for each of the generating coils. In other words, this is an overconstrained system. While we could use only two coils, three will improve accuracy.

## Bibliography
Hu, C., Song, S., Wang, X., Meng, M. Q. H., & Li, B. (2012). A novel positioning and orientation system based on three-axis magnetic coils. _IEEE Transactions on Magnetics, 48_(7), 2211–2219. https://doi.org/10.1109/TMAG.2012.2188537

Kim, W., Song, J., & Park, F. C. (2018). Closed-Form Position and Orientation Estimation for a Three-Axis Electromagnetic Tracking System. _IEEE Transactions on Industrial Electronics, 65_(5), 4331–4337. https://doi.org/10.1109/TIE.2017.2760244

Dennison, E. (2005). Off-Axis Field Due to a Magnetic Dipole Moment. Retrieved July 17, 2019, from https://tiggerntatie.github.io/emagnet/offaxis/mmoffaxis.htm